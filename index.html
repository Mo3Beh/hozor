<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨ ØµÙˆØªÛŒ Ø´Ø§Ø¯ Ùˆ Ù¾Ø±Ø§Ù†Ø±Ú˜ÛŒ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lalezar&display=swap');

        body {
            font-family: 'Lalezar', cursive, Arial, sans-serif;
            background-color: #fff8e1; /* Ú©Ø±Ù… Ø®ÛŒÙ„ÛŒ Ø®ÛŒÙ„ÛŒ Ø±ÙˆØ´Ù† */
            color: #424242;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        .container {
            background-color: #ffffff;
            padding: 35px 40px;
            border-radius: 30px;
            box-shadow: 0 18px 35px rgba(0, 0, 0, 0.1), 0 8px 15px rgba(0,0,0,0.07);
            text-align: center;
            width: 90%;
            max-width: 720px;
            position: relative;
        }

        h1 {
            color: #d81b60; /* ØµÙˆØ±ØªÛŒ Ù…Ø§Øª */
            font-size: 3.2em;
            margin-bottom: 20px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }

        p.instructions {
            font-size: 1.45em; /* Ú©Ù…ÛŒ Ø¨Ø²Ø±Ú¯ØªØ± */
            color: #4f4f4f;
            margin-bottom: 30px;
            line-height: 1.85;
        }
        p.instructions strong {
            color: #00695c; /* Ø³Ø¨Ø²Ø¢Ø¨ÛŒ ØªÛŒØ±Ù‡ */
            font-weight: bold;
            background-color: #e0f7fa; /* Ù¾Ø³ Ø²Ù…ÛŒÙ†Ù‡ Ø®ÛŒÙ„ÛŒ Ø±ÙˆØ´Ù† Ø¨Ø±Ø§ÛŒ ØªØ§Ú©ÛŒØ¯ */
            padding: 3px 8px;
            border-radius: 6px;
        }

        #speech-button {
            background: linear-gradient(45deg, #ff8a65 0%, #ff5252 100%); /* Ù†Ø§Ø±Ù†Ø¬ÛŒ Ø¨Ù‡ Ù‚Ø±Ù…Ø² */
            color: white;
            border: none;
            padding: 22px 45px; /* Ø¨Ø²Ø±Ú¯ØªØ± */
            font-size: 1.8em; /* Ø¨Ø²Ø±Ú¯ØªØ± */
            font-family: 'Lalezar', cursive;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            margin-bottom: 25px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 18px rgba(255, 82, 82, 0.4);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        #speech-button:hover {
            transform: translateY(-4px) scale(1.03);
            box-shadow: 0 10px 25px rgba(255, 82, 82, 0.5);
        }
        #speech-button:active {
            transform: translateY(-1px) scale(1.01);
        }
        #speech-button:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }
        .mic-icon {
            font-size: 1.4em;
            margin-left: 15px;
        }

        #speech-status, #message {
            margin-top: 20px;
            font-size: 1.25em; /* Ú©Ù…ÛŒ Ø¨Ø²Ø±Ú¯ØªØ± */
            min-height: 28px;
            transition: color 0.3s;
        }
        #speech-status { color: #1e88e5; /* Ø¢Ø¨ÛŒ */ }
        #message.success { color: #388e3c; font-weight: bold; }
        #message.error { color: #d32f2f; font-weight: bold; }
        #message.info { color: #f57c00; }


        #teacher-view-button {
            background-color: #0097a7; /* ÙÛŒØ±ÙˆØ²Ù‡â€ŒØ§ÛŒ ØªÛŒØ±Ù‡ ØªØ± */
            color: white;
            border: none;
            padding: 16px 32px; /* Ø¨Ø²Ø±Ú¯ØªØ± */
            font-size: 1.6em; /* Ø¨Ø²Ø±Ú¯ØªØ± */
            font-family: 'Lalezar', cursive;
            border-radius: 15px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            margin-top: 40px;
        }
        #teacher-view-button:hover {
            background-color: #00796b;
            transform: scale(1.05);
        }

        #teacher-area {
            margin-top: 40px;
            background-color: #e8f5e9;
            padding: 30px;
            border-radius: 25px;
            display: none;
            width: 100%;
            box-sizing: border-box;
        }
        h2 {
            color: #00695c;
            font-size: 2.3em; /* Ø¨Ø²Ø±Ú¯ØªØ± */
            margin-top: 0;
            margin-bottom: 25px;
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.06);
            border-radius: 12px;
            overflow: hidden;
        }
        th, td {
            border-bottom: 1px solid #dcedc8; /* Ø³Ø¨Ø² Ø®ÛŒÙ„ÛŒ Ø®ÛŒÙ„ÛŒ Ø±ÙˆØ´Ù† */
            padding: 16px 12px; /* Ù¾Ø¯ÛŒÙ†Ú¯ Ø¨ÛŒØ´ØªØ± */
            text-align: center;
            font-size: 1.15em; /* Ú©Ù…ÛŒ Ø¨Ø²Ø±Ú¯ØªØ± */
        }
        th {
            background-color: #4caf50; /* Ø³Ø¨Ø² Ø§ØµÙ„ÛŒ */
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 0.6px;
            font-weight: bold;
        }
        tr:last-child td {
            border-bottom: none;
        }
        tr:nth-child(even) td {
            background-color: #f1f8e9;
        }
        td.mood-normal { background-color: #fff9c4 !important; /* Ø²Ø±Ø¯ Ø±ÙˆØ´Ù† Ø¨Ø±Ø§ÛŒ Ø¹Ø§Ø¯ÛŒ */ }
        td.mood-good { background-color: #c8e6c9 !important; }
        td.mood-bad { background-color: #ffcdd2 !important; }
        td.mood-great { background-color: #b3e5fc !important; }
        td.mood-unknown { background-color: #eeeeee !important; /* Ø®Ø§Ú©Ø³ØªØ±ÛŒ Ø±ÙˆØ´Ù† Ø¨Ø±Ø§ÛŒ Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ */ }
        .name-verified { color: #2e7d32; font-weight: bold; }
        .name-unverified { color: #e65100; /* Ù†Ø§Ø±Ù†Ø¬ÛŒ ØªÛŒØ±Ù‡ */ }


        .popup-checkmark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background-color: rgba(39, 174, 96, 0.92); /* Ø³Ø¨Ø² Ø¨Ø§ Ø´ÙØ§ÙÛŒØª */
            color: white;
            padding: 35px 45px; /* Ø¨Ø²Ø±Ú¯ØªØ± */
            border-radius: 25px; /* Ú¯Ø±Ø¯ØªØ± */
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: transform 0.45s cubic-bezier(0.18, 0.89, 0.32, 1.28), opacity 0.35s ease-out;
            box-shadow: 0 12px 30px rgba(0,0,0,0.22);
        }
        .popup-checkmark.show {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }
        .popup-checkmark svg {
            width: 90px; /* Ø¨Ø²Ø±Ú¯ØªØ± */
            height: 90px; /* Ø¨Ø²Ø±Ú¯ØªØ± */
            margin-bottom: 18px;
        }
        .popup-checkmark .checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 3.5; /* Ú©Ù…ÛŒ Ø¶Ø®ÛŒÙ… ØªØ± */
            stroke-miterlimit: 10;
            stroke: white;
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) 0.3s forwards;
        }
        .popup-checkmark .checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            stroke-width: 4.5; /* Ø¶Ø®ÛŒÙ… ØªØ± */
            stroke: white;
            fill: none;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.7s forwards;
        }
        @keyframes stroke {
            100% {
                stroke-dashoffset: 0;
            }
        }
        .popup-checkmark p {
            font-size: 1.7em; /* Ø¨Ø²Ø±Ú¯ØªØ± */
            margin: 0;
            font-family: 'Lalezar', cursive;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1>Ø­Ø¶ÙˆØ± ØºÛŒØ§Ø¨ ØµÙˆØªÛŒ Ú©Ù„Ø§Ø³ Ø´Ø§Ø¯Ù…ÙˆÙ†!</h1>
        <p class="instructions">
            Ø¯Ú©Ù…Ù‡ "Ø´Ø±ÙˆØ¹ ØµØ­Ø¨Øª" Ø±Ùˆ ÙØ´Ø§Ø± Ø¨Ø¯Ù‡ Ùˆ Ø¨Ø§ ØµØ¯Ø§ÛŒ Ø±Ø³Ø§ Ø¨Ú¯Ùˆ: <br>
            <strong>"Ø³Ù„Ø§Ù…ØŒ [Ø§Ø³Ù… Ù‚Ø´Ù†Ú¯Øª] Ù‡Ø³ØªÙ… Ùˆ Ø§Ù…Ø±ÙˆØ² Ø­Ø§Ù„Ù… [Ø¹Ø§Ø¯ÛŒÙ‡/Ø®ÙˆØ¨Ù‡/Ø¨Ø¯Ù‡/Ø¹Ø§Ù„ÛŒÙ‡]"</strong>
        </p>

        <button id="speech-button" onclick="startSpeechRecognition()">
            <span class="mic-icon">ğŸ¤</span> Ø´Ø±ÙˆØ¹ ØµØ­Ø¨Øª
        </button>
        <div id="speech-status"></div>
        <div id="message"></div>

        <!-- Ø¯Ú©Ù…Ù‡ ØªØ³Øª ØµØ¯Ø§ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø·Ø§ÛŒØ§Ø¨ÛŒ) -->
        <!-- <button onclick="document.getElementById('success-sound').play()">ØªØ³Øª ØµØ¯Ø§</button> -->

        <button id="teacher-view-button" onclick="showTeacherView()">Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ù…Ø¹Ù„Ù…</button>

        <div id="teacher-area">
            <h2>Ù„ÛŒØ³Øª Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨ Ø§Ù…Ø±ÙˆØ²</h2>
            <table id="attendance-table">
                <thead>
                    <tr>
                        <th>Ø±Ø¯ÛŒÙ</th>
                        <th>Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² (Ù„ÛŒØ³Øª)</th>
                        <th>Ú¯ÙØªÙ‡ Ø´Ø¯Ù‡</th>
                        <th>Ø­Ø§Ù„ (Ú¯ÙØªÙ‡)</th>
                        <th>Ø­Ø§Ù„ (Ø·Ø¨Ù‚Ù‡â€ŒØ¨Ù†Ø¯ÛŒ)</th>
                        <th>Ø§ÛŒÙ…ÙˆØ¬ÛŒ</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <div class="popup-checkmark" id="success-popup">
        <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
            <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
            <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
        <p>Ø¹Ø§Ù„ÛŒ Ø¨ÙˆØ¯! Ø«Ø¨Øª Ø´Ø¯!</p>
    </div>

    <audio id="success-sound" src="success.mp3" preload="auto"></audio>
    <!-- <audio id="success-sound" src="https://actions.google.com/sounds/v1/alarms/dinner_bell_triangle.ogg" preload="auto"></audio> -->


    <script>
        const classList = [
            "Ù…Ø­Ù…Ø¯Ø­Ø³Ù† ÛŒØ²Ø¯Ø§Ù†ÛŒ", "Ù…Ø­Ù…Ø¯Ø·Ø§Ù‡Ø§ Ø®Ø³Ø±ÙˆÛŒ", "Ù…Ø­Ù…Ø¯Ø­Ø³ÛŒÙ† ÛŒØ²Ø¯Ø§Ù†ÛŒ", "Ù…Ø­Ù…Ø¯ Ø­Ø³ÛŒÙ†ÛŒ",
            "Ø§Ù…ÛŒØ±Ù…Ø­Ù…Ø¯ Ø¯Ù‡Ù‚Ø§Ù†ÛŒ", "Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ† Ø¯Ù‡Ù‚Ø§Ù†ÛŒ", "Ù…Ø±ØªØ¶Ø§ Ø³Ø¨Ø²Ù‡ Ø¨ÛŒÙ†", "Ù¾Ø§Ø±Ø³Ø§ ØºÙ„Ø§Ù…ÛŒ",
            "Ù†ÛŒÙ„ÙˆÙØ± Ù‚Ø§Ø³Ù…ÛŒ", "Ø§Ù…ÛŒØ±Ø§Ø­Ù…Ø¯ Ø±Ù‡ Ø¢Ù…ÙˆØ²", "Ú©Ø§Ø±Ù† Ù†Ø§Ø¸Ø±ÛŒ", "Ú©ÛŒØ§Ù† Ù¾Ø§Ø±Ø³Ø§" // Ú†Ù†Ø¯ Ù†Ø§Ù… Ø¯ÛŒÚ¯Ø±
        ].map(name => name.trim().replace(/ÛŒ/g, 'ÙŠ').replace(/Ú©/g, 'Ùƒ')); // Ù†Ø±Ù…Ø§Ù„ Ø³Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø± Ø®ÙˆØ¯ Ù„ÛŒØ³Øª

        let attendanceList = [];
        let studentCounter = 0;

        const speechButton = document.getElementById('speech-button');
        const speechStatusEl = document.getElementById('speech-status');
        const messageEl = document.getElementById('message');
        const successPopup = document.getElementById('success-popup');
        const successSound = document.getElementById('success-sound');

        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† "Ø¹Ø§Ø¯ÛŒÙ‡" Ø¨Ù‡ moodMap
        const moodMap = {
            "Ø¹Ø§Ø¯ÛŒÙ‡": { normalized: "Ø¹Ø§Ø¯ÛŒÙ‡", emoji: "ğŸ˜" }, "Ø¹Ø§Ø¯ÛŒ Ø§Ù…": { normalized: "Ø¹Ø§Ø¯ÛŒÙ‡", emoji: "ğŸ˜" }, "Ø¹Ø§Ø¯ÛŒ": { normalized: "Ø¹Ø§Ø¯ÛŒÙ‡", emoji: "ğŸ˜" },
            "Ø®ÙˆØ¨Ù‡": { normalized: "Ø®ÙˆØ¨Ù‡", emoji: "ğŸ˜Š" }, "Ø®ÙˆØ¨Ù…": { normalized: "Ø®ÙˆØ¨Ù‡", emoji: "ğŸ˜Š" }, "Ø®ÙˆØ¨": { normalized: "Ø®ÙˆØ¨Ù‡", emoji: "ğŸ˜Š" },
            "Ø¨Ø¯Ù‡": { normalized: "Ø¨Ø¯Ù‡", emoji: "ğŸ˜Ÿ" }, "Ø¨Ø¯Ù…": { normalized: "Ø¨Ø¯Ù‡", emoji: "ğŸ˜Ÿ" }, "Ø¨Ø¯": { normalized: "Ø¨Ø¯Ù‡", emoji: "ğŸ˜Ÿ" },
            "Ø¹Ø§Ù„ÛŒÙ‡": { normalized: "Ø¹Ø§Ù„ÛŒÙ‡", emoji: "ğŸ˜ƒ" }, "Ø¹Ø§Ù„ÛŒÙ…": { normalized: "Ø¹Ø§Ù„ÛŒÙ‡", emoji: "ğŸ˜ƒ" }, "Ø¹Ø§Ù„ÛŒ Ø§Ù…": { normalized: "Ø¹Ø§Ù„ÛŒÙ‡", emoji: "ğŸ˜ƒ" }, "Ø¹Ø§Ù„ÛŒ": { normalized: "Ø¹Ø§Ù„ÛŒÙ‡", emoji: "ğŸ˜ƒ" }
        };

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'fa-IR';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                speechStatusEl.textContent = "Ú¯ÙˆØ´Ù… Ø¨Ø§ Ø´Ù…Ø§Ø³Øª Ù‚Ù‡Ø±Ù…Ø§Ù†...";
                speechButton.disabled = true;
                speechButton.innerHTML = '<span class="mic-icon">ğŸ¤</span> Ø¯Ø± Ø­Ø§Ù„ Ø´Ù†ÛŒØ¯Ù†...';
                messageEl.textContent = "";
                messageEl.className = '';
            };

            recognition.onspeechend = () => {
                speechStatusEl.textContent = "Ø´Ù†ÛŒØ¯Ù…! Ø¯Ø§Ø±Ù… Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ù…...";
                // recognition.stop(); // Ù…Ø¹Ù…ÙˆÙ„Ø§ Ø®ÙˆØ¯Ú©Ø§Ø± Ù…ØªÙˆÙ‚Ù Ù…ÛŒ Ø´ÙˆØ¯ØŒ Ø§Ù…Ø§ Ø§Ú¯Ø± Ù†Ù‡ØŒ Ø§ÛŒÙ† Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript.trim();
                speechStatusEl.textContent = `Ú¯ÙØªÛŒ: "${transcript}"`;
                processSpeech(transcript);
            };

            recognition.onerror = (event) => {
                let errorMsg = "Ø§ÙˆÙ‡! ÛŒÙ‡ Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø§ÙˆÙ…Ø¯Ù‡!";
                if (event.error === 'no-speech') errorMsg = "Ù…Ø«Ù„ Ø§ÛŒÙ†Ú©Ù‡ ØµØ¯Ø§ÛŒÛŒ Ù†Ø´Ù†ÛŒØ¯Ù…! Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¯Ú©Ù…Ù‡ Ø±Ùˆ Ø¨Ø²Ù† Ùˆ ØµØ­Ø¨Øª Ú©Ù†.";
                else if (event.error === 'audio-capture') errorMsg = "Ù†ØªÙˆÙ†Ø³ØªÙ… ØµØ¯Ø§Øª Ø±Ùˆ Ø§Ø² Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¨Ú¯ÛŒØ±Ù…. Ù…Ø·Ù…Ø¦Ù†ÛŒ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ†Øª ÙˆØµÙ„Ù‡ Ùˆ Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø§Ø¯ÛŒØŸ";
                else if (event.error === 'not-allowed') errorMsg = "Ø§Ø¬Ø§Ø²Ù‡ Ù†Ø¯Ø§Ø¯ÛŒ Ø§Ø² Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ù…. Ø¨Ø±Ø§ÛŒ Ø´Ù†ÛŒØ¯Ù† ØµØ¯Ø§Øª Ø¨Ù‡ Ø§Ø¬Ø§Ø²Ù‡â€ŒØ§Øª Ù†ÛŒØ§Ø² Ø¯Ø§Ø±Ù….";
                else errorMsg = `Ø®Ø·Ø§ Ø¯Ø± ØªØ´Ø®ÛŒØµ: ${event.error}`;
                
                messageEl.textContent = errorMsg;
                messageEl.className = 'error';
                speechStatusEl.textContent = ""; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª Ù‚Ø¨Ù„ÛŒ
            };
            
            recognition.onend = () => {
                speechButton.disabled = false;
                speechButton.innerHTML = '<span class="mic-icon">ğŸ¤</span> Ø´Ø±ÙˆØ¹ ØµØ­Ø¨Øª';
                // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§ÛŒÙ†Ú©Ù‡ speechStatusEl Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ ÛŒÚ© Ù¾ÛŒØ§Ù… Ù¾ÛŒØ´ÙØ±Ø¶ Ù†Ø¯Ø§Ø±Ø¯ ØªØ§ Ø¨Ø§ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§/Ù…ÙˆÙÙ‚ÛŒØª ØªØ¯Ø§Ø®Ù„ Ù†Ú©Ù†Ø¯
                if (speechStatusEl.textContent.includes("Ø´Ù†ÛŒØ¯Ù…") || speechStatusEl.textContent.includes("Ú¯ÙˆØ´Ù…")) {
                    speechStatusEl.textContent = "Ø¨Ø±Ø§ÛŒ ØµØ­Ø¨Øª Ø¯ÙˆØ¨Ø§Ø±Ù‡ØŒ Ø¯Ú©Ù…Ù‡ Ø±Ùˆ Ø¨Ø²Ù†.";
                }
            };

        } else {
            speechButton.disabled = true;
            speechButton.textContent = "Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯";
            speechStatusEl.textContent = "Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² ØªØ´Ø®ÛŒØµ Ú¯ÙØªØ§Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ù‡. Ù„Ø·ÙØ§ Ø§Ø² Ú¯ÙˆÚ¯Ù„ Ú©Ø±ÙˆÙ… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.";
            speechStatusEl.style.color = "red";
        }

        function startSpeechRecognition() {
            // Ù‚Ø¨Ù„ Ø§Ø² Ø´Ø±ÙˆØ¹ØŒ Ø§Ú¯Ø± Ù¾ÛŒØ§Ù…ÛŒ Ø§Ø² Ù‚Ø¨Ù„ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ Ù¾Ø§Ú© Ø´ÙˆØ¯
            messageEl.textContent = "";
            messageEl.className = '';
            speechStatusEl.textContent = ""; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙˆØ¶Ø¹ÛŒØª Ù‚Ø¨Ù„ÛŒ

            // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† context ØµÙˆØªÛŒ (Ú¯Ø§Ù‡ÛŒ Ø¨Ø±Ø§ÛŒ iOS Ù„Ø§Ø²Ù… Ø§Ø³Øª)
            if (successSound && successSound.paused) {
                successSound.play().then(() => successSound.pause()).catch(()=>{});
            }

            if (recognition) {
                try {
                    recognition.start();
                } catch(e) {
                    console.error("Ø®Ø·Ø§ Ø¯Ø± Ø´Ø±ÙˆØ¹ ØªØ´Ø®ÛŒØµ:", e);
                    messageEl.textContent = "ÛŒÚ© Ù„Ø­Ø¸Ù‡ ØµØ¨Ø± Ú©Ù† Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¯Ú©Ù…Ù‡ Ø±Ùˆ Ø¨Ø²Ù†.";
                    messageEl.className = 'error';
                    speechButton.disabled = false; 
                    speechButton.innerHTML = '<span class="mic-icon">ğŸ¤</span> Ø´Ø±ÙˆØ¹ ØµØ­Ø¨Øª';
                }
            }
        }

        function playSuccessFeedback() {
            if (successSound) {
                successSound.currentTime = 0;
                const playPromise = successSound.play();
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        // Ù¾Ø®Ø´ Ù…ÙˆÙÙ‚ÛŒØª Ø¢Ù…ÛŒØ²
                    }).catch(error => {
                        console.warn("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø®Ø´ ØµØ¯Ø§: ", error);
                        // Ù…Ù…Ú©Ù† Ø§Ø³Øª Ú©Ø§Ø±Ø¨Ø± Ù‡Ù†ÙˆØ² Ø¨Ø§ ØµÙØ­Ù‡ ØªØ¹Ø§Ù…Ù„ Ù†Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
                        // ÛŒØ§ Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡ Ù¾Ø®Ø´ Ø®ÙˆØ¯Ú©Ø§Ø± Ø±Ø§ Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù‡ Ø¨Ø§Ø´Ø¯.
                        // Ø¯Ø± Ø§ÛŒÙ† Ø­Ø§Ù„ØªØŒ ÙÙ‚Ø· Ù¾Ø§Ù¾â€ŒØ¢Ù¾ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                    });
                }
            }

            successPopup.classList.add('show');
            setTimeout(() => {
                successPopup.classList.remove('show');
            }, 2200); // Ø²Ù…Ø§Ù† Ù†Ù…Ø§ÛŒØ´ Ù¾Ø§Ù¾ Ø¢Ù¾
        }

        function processSpeech(transcript) {
            // Regex Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø¬Ù…Ù„Ù‡: "Ø³Ù„Ø§Ù…ØŒ [Ù†Ø§Ù…] Ù‡Ø³ØªÙ… Ùˆ Ø§Ù…Ø±ÙˆØ² Ø­Ø§Ù„Ù… [Ø­Ø§Ù„]"
            const mainRegex = /Ø³Ù„Ø§Ù…(?:ØŒ|\sØŒ)?\s*(.*?)\s+Ù‡Ø³ØªÙ…\s+(?:Ùˆ\s*)?(?:Ø§Ù…Ø±ÙˆØ²\s*)?Ø­Ø§Ù„Ù…\s+(.*)/i;
            // (?:ØŒ|\sØŒ)? ÛŒØ¹Ù†ÛŒ Ú©Ø§Ù…Ø§ ÛŒØ§ ÙØ§ØµÙ„Ù‡ Ùˆ Ú©Ø§Ù…Ø§ Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø§Ø³Øª
            // (?:Ùˆ\s*)? (?:Ø§Ù…Ø±ÙˆØ²\s*)? Ú©Ù„Ù…Ø§Øª "Ùˆ" Ùˆ "Ø§Ù…Ø±ÙˆØ²" Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ù‡Ø³ØªÙ†Ø¯

            let studentNameFromSpeech = "";
            let statedMood = "";
            let match = transcript.match(mainRegex);

            if (match && match[1] && match[2]) {
                studentNameFromSpeech = match[1].trim();
                statedMood = match[2].trim().replace(/\.$/, ''); // Ø­Ø°Ù Ù†Ù‚Ø·Ù‡ Ù¾Ø§ÛŒØ§Ù†ÛŒ Ø§Ø­ØªÙ…Ø§Ù„ÛŒ
            } else {
                // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡â€ŒØªØ±
                const simplerRegex1 = /Ù…Ù†\s+(.*?)\s+(?:Ù‡Ø³ØªÙ…\s*)?(?:Ùˆ\s*)?(?:Ø§Ù…Ø±ÙˆØ²\s*)?Ø­Ø§Ù„Ù…\s+(.*)/i;
                match = transcript.match(simplerRegex1);
                if (match && match[1] && match[2]) {
                    studentNameFromSpeech = match[1].trim();
                    statedMood = match[2].trim().replace(/\.$/, '');
                    messageEl.textContent = `Ø¬Ù…Ù„Ù‡â€ŒØ§Øª Ú©Ù…ÛŒ ÙØ±Ù‚ Ø¯Ø§Ø´Øª ÙˆÙ„ÛŒ Ù…ØªÙˆØ¬Ù‡ Ø´Ø¯Ù…! `;
                    messageEl.className = 'info';
                } else {
                    const simplerRegex2 = /^(.*?)\s+Ø­Ø§Ù„Ù…\s+(.*)/i; // Ù…Ø«Ù„Ø§ "Ø³Ø§Ø±Ø§ Ø­Ø§Ù„Ù… Ø®ÙˆØ¨Ù‡"
                    match = transcript.match(simplerRegex2);
                     if (match && match[1] && match[2]) {
                        studentNameFromSpeech = match[1].trim();
                        statedMood = match[2].trim().replace(/\.$/, '');
                        messageEl.textContent = `Ø¬Ù…Ù„Ù‡â€ŒØ§Øª Ø®ÛŒÙ„ÛŒ Ø®Ù„Ø§ØµÙ‡ Ø¨ÙˆØ¯ ÙˆÙ„ÛŒ Ø¨Ø§Ø²Ù… ÙÙ‡Ù…ÛŒØ¯Ù…! `;
                        messageEl.className = 'info';
                    } else {
                        messageEl.textContent = `Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ù†ØªÙˆÙ†Ø³ØªÙ… Ø§Ø³Ù…Øª Ùˆ Ø­Ø§Ù„Øª Ø±Ùˆ Ø§Ø² Ø¬Ù…Ù„Ù‡â€ŒØ§ÛŒ Ú©Ù‡ Ú¯ÙØªÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ù†Ù…. Ù„Ø·ÙØ§ Ø¯Ù‚ÛŒÙ‚ Ø¨Ú¯Ùˆ: "Ø³Ù„Ø§Ù…ØŒ [Ø§Ø³Ù…Øª] Ù‡Ø³ØªÙ… Ùˆ Ø§Ù…Ø±ÙˆØ² Ø­Ø§Ù„Ù… [Ø¹Ø§Ø¯ÛŒÙ‡/Ø®ÙˆØ¨Ù‡/Ø¨Ø¯Ù‡/Ø¹Ø§Ù„ÛŒÙ‡]"`;
                        messageEl.className = 'error';
                        setTimeout(() => { if (messageEl.className === 'error' && messageEl.textContent.startsWith("Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ù†ØªÙˆÙ†Ø³ØªÙ…")) messageEl.textContent = ""; }, 7000);
                        return;
                    }
                }
            }
            
            const normalizedSpokenName = studentNameFromSpeech.replace(/ÛŒ/g, 'ÙŠ').replace(/Ú©/g, 'Ùƒ');
            const foundStudent = classList.find(nameInList => nameInList === normalizedSpokenName);

            let officialName = studentNameFromSpeech;
            let nameVerified = false;

            const currentInfoMessage = messageEl.textContent.includes("ÙˆÙ„ÛŒ") ? messageEl.textContent : "";

            if (foundStudent) {
                officialName = foundStudent;
                nameVerified = true;
                messageEl.textContent = currentInfoMessage + `Ø´Ù†Ø§Ø®ØªÙ…Øª ${officialName.replace(/ÙŠ/g, 'ÛŒ').replace(/Ùƒ/g, 'Ú©')}! `; // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§ ÛŒ Ùˆ Ú© ÙØ§Ø±Ø³ÛŒ
                messageEl.className = 'info';
            } else {
                messageEl.textContent = currentInfoMessage + `Ø§Ø³Ù… "${studentNameFromSpeech}" ØªÙˆÛŒ Ù„ÛŒØ³Øª Ú©Ù„Ø§Ø³ Ù†Ø¨ÙˆØ¯ØŒ ÙˆÙ„ÛŒ Ø«Ø¨ØªØ´ Ù…ÛŒâ€ŒÚ©Ù†Ù…. `;
                messageEl.className = 'info';
            }

            // Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø­Ø§Ù„ Ùˆ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§ÛŒÙ…ÙˆØ¬ÛŒ
            let normalizedMood = "Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡";
            let moodEmoji = "ğŸ¤”";
            const moodKey = statedMood.toLowerCase();
            
            // Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯Ù‚ÛŒÙ‚ Ø¯Ø± moodMap
            if (moodMap[moodKey]) {
                normalizedMood = moodMap[moodKey].normalized;
                moodEmoji = moodMap[moodKey].emoji;
            } else {
                // Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ø§Ù…Ù„ Ø´ÙˆÙ†Ø¯Ù‡ (includes) Ø§Ú¯Ø± Ø¯Ù‚ÛŒÙ‚ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯
                for (const key in moodMap) {
                    if (moodKey.includes(key) || moodKey.includes(moodMap[key].normalized)) { // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú†Ú© Ø¨Ø§ normalized
                        normalizedMood = moodMap[key].normalized;
                        moodEmoji = moodMap[key].emoji;
                        break;
                    }
                }
            }


            const existingStudentIndex = attendanceList.findIndex(s => s.officialName === officialName);
            if (existingStudentIndex > -1) {
                attendanceList[existingStudentIndex].statedMood = statedMood;
                attendanceList[existingStudentIndex].mood = normalizedMood;
                attendanceList[existingStudentIndex].emoji = moodEmoji;
                attendanceList[existingStudentIndex].spokenName = studentNameFromSpeech;
                attendanceList[existingStudentIndex].nameVerified = nameVerified;
                messageEl.textContent += `Ø­Ø¶ÙˆØ±Øª Ù‚Ø¨Ù„Ø§ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ø­Ø§Ù„Øª Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯: ${statedMood} ${moodEmoji}`;
            } else {
                studentCounter++;
                attendanceList.push({ 
                    id: studentCounter, 
                    officialName: officialName, 
                    spokenName: studentNameFromSpeech, 
                    nameVerified: nameVerified, 
                    statedMood: statedMood,
                    mood: normalizedMood, 
                    emoji: moodEmoji 
                });
                messageEl.textContent += (messageEl.textContent.includes("Ø´Ù†Ø§Ø®ØªÙ…Øª") || messageEl.textContent.includes("Ù†Ø¨ÙˆØ¯") ? "" : `Ø¢ÙØ±ÛŒÙ† ${officialName.replace(/ÙŠ/g, 'ÛŒ').replace(/Ùƒ/g, 'Ú©')}! `) + `Ø­Ø¶ÙˆØ±Øª Ø¨Ø§ Ø­Ø§Ù„ ${statedMood} ${moodEmoji} Ø«Ø¨Øª Ø´Ø¯.`;
            }
            
            messageEl.className = 'success';
            playSuccessFeedback();

            if (document.getElementById('teacher-area').style.display === 'block') {
                renderTable();
            }
            setTimeout(() => {
                // ÙÙ‚Ø· Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª ÛŒØ§ Ø§Ø·Ù„Ø§Ø¹Ø§ØªÛŒ Ú©Ù‡ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø«Ø¨Øª Ø§Ø³Øª Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†
                if (messageEl.className === 'success' || (messageEl.className === 'info' && messageEl.textContent.includes("Ø«Ø¨Øª Ø´Ø¯"))) {
                     messageEl.textContent = "";
                }
                if (speechStatusEl.textContent.includes("Ú¯ÙØªÛŒ")) {
                     speechStatusEl.textContent = "Ø¨Ø±Ø§ÛŒ ØµØ­Ø¨Øª Ø¯ÙˆØ¨Ø§Ø±Ù‡ØŒ Ø¯Ú©Ù…Ù‡ Ø±Ùˆ Ø¨Ø²Ù†.";
                }
            }, 5500);
        }

        function showTeacherView() {
            const teacherArea = document.getElementById('teacher-area');
            const teacherButton = document.getElementById('teacher-view-button');
            if (teacherArea.style.display === 'none' || teacherArea.style.display === '') {
                teacherArea.style.display = 'block';
                teacherButton.textContent = "Ø¨Ø³ØªÙ† Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ù…Ø¹Ù„Ù…";
                renderTable();
            } else {
                teacherArea.style.display = 'none';
                teacherButton.textContent = "Ø¨Ø§Ø²Ø¯ÛŒØ¯ Ù…Ø¹Ù„Ù…";
            }
        }

        function renderTable() {
            const tableBody = document.getElementById('attendance-table').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ''; 

            if (attendanceList.length === 0) {
                const row = tableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 6;
                cell.textContent = "Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ Ø­Ø¶ÙˆØ± Ù†Ø²Ø¯Ù‡.";
                cell.style.textAlign = "center";
                return;
            }

            attendanceList.sort((a, b) => a.id - b.id);

            attendanceList.forEach((student) => {
                const row = tableBody.insertRow();
                
                row.insertCell().textContent = student.id;
                
                const officialNameCell = row.insertCell();
                officialNameCell.textContent = student.officialName.replace(/ÙŠ/g, 'ÛŒ').replace(/Ùƒ/g, 'Ú©'); // Ù†Ù…Ø§ÛŒØ´ Ø¨Ø§ ÛŒ Ùˆ Ú© ÙØ§Ø±Ø³ÛŒ
                officialNameCell.classList.add(student.nameVerified ? 'name-verified' : 'name-unverified');
                if (!student.nameVerified) officialNameCell.title = "Ø§ÛŒÙ† Ù†Ø§Ù… Ø¯Ø± Ù„ÛŒØ³Øª Ø§ÙˆÙ„ÛŒÙ‡ Ú©Ù„Ø§Ø³ Ù†Ø¨ÙˆØ¯.";
                
                row.insertCell().textContent = student.spokenName;
                row.insertCell().textContent = student.statedMood;
                
                const moodCell = row.insertCell();
                moodCell.textContent = student.mood;
                
                row.insertCell().textContent = student.emoji;

                if (student.mood === "Ø¹Ø§Ø¯ÛŒÙ‡") moodCell.classList.add('mood-normal');
                else if (student.mood === "Ø®ÙˆØ¨Ù‡") moodCell.classList.add('mood-good');
                else if (student.mood === "Ø¨Ø¯Ù‡") moodCell.classList.add('mood-bad');
                else if (student.mood === "Ø¹Ø§Ù„ÛŒÙ‡") moodCell.classList.add('mood-great');
                else moodCell.classList.add('mood-unknown');
            });
        }
    </script>
</body>
</html>
